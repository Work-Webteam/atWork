<?php

use Drupal\file\Entity\File;
use Drupal\core\Entity\EntityManager;
/**
 * @file
 * Primary module hooks for Atwork Poll module.
 */

/**
 * Implements HOOK_preprocess_HOOK
 * 
 * Preprocess theme variables for field--poll--field-author--poll.
 */
function atworknext_preprocess_field__poll__field_author__poll(&$variables) {
	$variables['timestamp'] = $variables['element']['#object']->getCreated();
	
}

/**
 * Implements HOOK_preprocess_HOOK
 *
 * Preprocess theme variables for field__poll__field_tags__poll.
 */
function atworknext_preprocess_field__poll__field_tags__poll(&$variables) {
	$poll_id = $variables['element']['#object']->id();
	$user_id= \Drupal::currentUser()->id();
	$view_count = '';
	
	try {
	  $connection = \Drupal::database();
	  $query = $connection->query("INSERT IGNORE INTO atwork_poll_views(poll_id,uid) VALUES (" . $poll_id . ", " . $user_id. ")");
	  $result = $query->fetch();
	} 
	catch(Exception $e) {
		\Drupal::logger('type')->error($e->getMessage());
	}
	
	try {
	  $connection = \Drupal::database();
		$query = $connection->query("SELECT COUNT(uid) AS count FROM atwork_poll_views where poll_id = " . $poll_id . ";");
	  $view_count = $query->fetch();
	} 
	catch(Exception $e) {
		\Drupal::logger('type')->error($e->getMessage());
	}
	$variables['poll_views'] = $view_count->count;
}
